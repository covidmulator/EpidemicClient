<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Covidmulator Visualization</title>
</head>
<body>
  <div id="map"></div>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=031b39e1da863f6ab5eee64cf4224067&libraries=clusterer"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const mapContainer = document.getElementById('map');
    const mapOption = {
      center: new kakao.maps.LatLng(37.5057679, 127.02899),
      // draggable: false,
      level: 7,
    };

    const map = new kakao.maps.Map(mapContainer, mapOption); 
  </script>

  <style>
    body {
      margin: 0;
    }

    #map {
      width: 100vw;
      height: 100vh;
    }
  </style>

  <script>
    /*
    EMPTY = 0
    COMMON = 2
    VIRUS = 1
    ISOLATION = 3
    */
    const commonIcon = new kakao.maps.MarkerImage(
      '/common.png',
      new kakao.maps.Size(40, 40),
      {
          offset: new kakao.maps.Point(16, 34),
          alt: '일반 시민',
          shape: 'poly',
          coords: "1,20,1,9,5,2,10,0,21,0,27,3,30,9,30,20,17,33,14,33"
      },
    );

    const virusIcon = new kakao.maps.MarkerImage(
      '/virus.png',
      new kakao.maps.Size(40, 40),
      {
          offset: new kakao.maps.Point(16, 34),
          alt: '감염된 시민',
          shape: 'poly',
          coords: "1,20,1,9,5,2,10,0,21,0,27,3,30,9,30,20,17,33,14,33"
      },
    );

    const isolationIcon = new kakao.maps.MarkerImage(
      '/isolation.png',
      new kakao.maps.Size(40, 40),
      {
          offset: new kakao.maps.Point(16, 34),
          alt: '격리된 시민',
          shape: 'poly',
          coords: "1,20,1,9,5,2,10,0,21,0,27,3,30,9,30,20,17,33,14,33"
      },
    );
  </script>

  <script>
    const endpoint = 'http://13.59.81.160:3000/api/matrix';
    const cluster = new kakao.maps.MarkerClusterer({
      map: map,
      markers: [],
      gridSize: 35,
      averageCenter: true,
      disableClickZoom: true,
      styles: [{
        width : '53px', height : '52px',
        color: '#fff',
        textAlign: 'center',
        lineHeight: '54px'
      }]
    });

    const convertLatLng = (x, y) => {
      return {
        lat: 37.508174 + 0.000392 * x,
        lng: 127.007216 + 0.003776 * y,
      };
    };

    const displayMatrix = (matrix) => {
      cluster.clear();
      const markers = [];
      for (let i = 0; i < 15; i += 1) {
        for (let j = 0; j < 15; j += 1) {
          const idx = i * 15 + j;
          if (matrix[idx]) {
            const {
              lat, lng
            } = convertLatLng(i, j);
            markers.push(new kakao.maps.Marker({
              position: new kakao.maps.LatLng(lat, lng),
              image: matrix[idx] === 1 ? virusIcon :
                     matrix[idx] === 2 ? commonIcon :
                     matrix[idx] === 3 ? isolationIcon :
                     null
            }));
          }
        }
      }
      cluster.addMarkers(markers);
    };

    let data;
    (async () => {
      data = await axios.get(`${endpoint}/v0`);
      data = data.data.data;
      let i = 0;
      setInterval(() => {
        displayMatrix(data[i].matrix[0]);
        i++;
      }, 500)
    })();
  </script>
</body>
</html>